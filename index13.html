<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .mb-3 {
            margin-bottom: 1rem !important; /* Adding more space between inputs */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Calculus</a>
        </div>
    </nav>
    
    <div class="container mt-5">
    <h1>Calculateur d'impôts</h1>
    <div class="mb-3">
        <label for="employmentIncome" class="form-label" title="Entrez le revenu total de votre emploi.">Revenu d'emploi:</label>
        <input id="employmentIncome" type="number" class="form-control" placeholder="Entrez votre revenu d'emploi">
    </div>
    <div class="mb-3">
        <label for="capitalGains" class="form-label" title="Entrez le montant total de vos gains en capital.">Gain en capital:</label>
        <input id="capitalGains" type="number" class="form-control" placeholder="Entrez votre gain en capital">
    </div>

    <!-- Dividend inputs in the same row -->
    <div class="row">
        <div class="col-12 col-md-6 mb-3">
            <label for="determinedDividend" class="form-label" title="Dividendes déterminés de vos investissements.">Dividende déterminé:</label>
            <input id="determinedDividend" type="number" class="form-control" placeholder="Entrez votre dividende déterminé">
        </div>
        <div class="col-12 col-md-6 mb-3">
            <label for="undeterminedDividend" class="form-label" title="Dividendes non déterminés de vos investissements.">Dividende non-déterminé:</label>
            <input id="undeterminedDividend" type="number" class="form-control" placeholder="Entrez votre dividende non-déterminé">
        </div>
    </div>

    <!-- Combined business and property income inputs in the same row -->
    <div class="row">
        <div class="col-12 col-md-6 mb-3">
            <label for="propertyIncome" class="form-label" title="Revenu généré par la propriété, comme la location.">Revenu de biens:</label>
            <input id="propertyIncome" type="number" class="form-control" placeholder="Entrez votre revenu de biens">
        </div>
        <div class="col-12 col-md-6 mb-3">
            <label for="businessIncome" class="form-label" title="Revenu de votre entreprise ou activité autonome.">Revenu d'entreprise:</label>
            <input id="businessIncome" type="number" class="form-control" placeholder="Entrez votre revenu d'entreprise">
        </div>
    </div>
        <!-- Button container for responsive layout -->
        <div class="d-flex flex-wrap align-items-center justify-content-between">
            <button class="btn btn-primary" onclick="calculateTotalTax()">Calculer les Impôts</button>
            <button class="btn btn-secondary" onclick="resetFields()">Réinitialiser</button>
            <button class="btn btn-info" onclick="showLogs()">Afficher les détails</button>
            
        <!-- Dropdown for Deductions -->
        <div class="dropdown">
            <button class="btn btn-warning dropdown-toggle" type="button" id="deductionsMenu" data-bs-toggle="dropdown" aria-expanded="false">
                Déductions
            </button>
            <ul class="dropdown-menu" aria-labelledby="deductionsMenu">
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#celiappModal">CELIAPP</a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#reerModal">REER</a></li>
                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#dgcModal">DGC</a></li>
            </ul>
        </div>
            
            <!-- Dropdown for Options with Checklists -->
            <div class="dropdown">
                <button class="btn btn-success dropdown-toggle" type="button" id="optionsMenu" data-bs-toggle="dropdown" aria-expanded="false">
                    Options
                </button>
                <ul class="dropdown-menu" aria-labelledby="optionsMenu">
                    <li><a class="dropdown-item"><input type="checkbox" checked> Abattement QC</a></li>
                    <li><a class="dropdown-item"><input type="checkbox" checked> Crédit d'impôt personnel</a></li>
                    <li><a class="dropdown-item"><input type="checkbox" checked disabled> Invididu</a></li>
                    <li><a class="dropdown-item"><input type="checkbox" disabled> Société par actions</a></li>
                </ul>
            </div>
        </div>
        
        <!-- Result Display -->
        <div id="result" class="mt-3"></div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Détails des Calculs</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastBody"></div>
            </div>
        </div>
    </div>

    <!-- Modal for CELIAPP -->
    <div class="modal fade" id="celiappModal" tabindex="-1" aria-labelledby="celiappModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="celiappModalLabel">Impact de l'investissement CELIAPP</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="number" id="celiappInput" class="form-control" placeholder="Entrez le montant de votre investissement CELIAPP">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="calculateCeliappImpact()">Calculer l'impact</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for REER -->
    <div class="modal fade" id="reerModal" tabindex="-1" aria-labelledby="reerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reerModalLabel">Impact de l'investissement REER</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="number" id="reerInput" class="form-control" placeholder="Entrez le montant de votre investissement REER">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="calculateReerImpact()">Calculer l'impact</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for DGC -->
    <div class="modal fade" id="dgcModal" tabindex="-1" aria-labelledby="dgcModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dgcModalLabel">Impact de la donation DGC</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="number" id="dgcInput" class="form-control" placeholder="Entrez le montant de votre donation DGC">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="calculateDgcImpact()">Calculer l'impact</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    let detailedLogs = "";

    function logDetailedResults(logs) {
        detailedLogs = logs.join('\n');
        console.log(detailedLogs);
    }

    function calculateFederalTax(income) {
        let logs = [`Calcul des impôts fédéraux pour un revenu de $${income}.`];
        let tax = 0;
        if (income <= 55867) {
            tax = income * 0.15;
            logs.push(`Le revenu jusqu'à $55,867 est imposé à 15% : $${tax.toFixed(2)}`);
        } else {
            let initialTax = 55867 * 0.15;
            tax = initialTax;
            logs.push(`Les premiers $55,867 sont imposés à 15% : $${initialTax.toFixed(2)}`);
            if (income <= 111733) {
                tax += (income - 55867) * 0.205;
                logs.push(`Le revenu de $55,867 à $111,733 est imposé à 20.5% : $${((income - 55867) * 0.205).toFixed(2)}`);
            } else {
                let middleTax = (111733 - 55867) * 0.205;
                tax += middleTax;
                logs.push(`Les $55,866 suivants sont imposés à 20.5% : $${middleTax.toFixed(2)}`);
                if (income <= 173205) {
                    tax += (income - 111733) * 0.26;
                    logs.push(`Le revenu de $111,733 à $173,205 est imposé à 26% : $${((income - 111733) * 0.26).toFixed(2)}`);
                } else {
                    let higherTax = (173205 - 111733) * 0.26;
                    tax += higherTax;
                    logs.push(`Les $61,472 suivants sont imposés à 26% : $${higherTax.toFixed(2)}`);
                    if (income <= 246752) {
                        tax += (income - 173205) * 0.29;
                        logs.push(`Le revenu de $173,205 à $246,752 est imposé à 29% : $${((income - 173205) * 0.29).toFixed(2)}`);
                    } else {
                        let highestTax = (246752 - 173205) * 0.29;
                        tax += highestTax;
                        tax += (income - 246752) * 0.33;
                        logs.push(`Les $73,547 suivants sont imposés à 29% : $${highestTax.toFixed(2)}`);
                        logs.push(`Le revenu supérieur à $246,752 est imposé à 33% : $${((income - 246752) * 0.33).toFixed(2)}`);
                    }
                }
            }
        }
        let abatedTax = tax - (tax * 0.165);
        logs.push(`Application de l'abattement de 16.5%, réduction de l'impôt de $${(tax * 0.165).toFixed(2)} à $${abatedTax.toFixed(2)}.`);
        return [abatedTax, logs];
    }

    function calculateQuebecTax(income) {
        let logs = [`Calcul des impôts du Québec pour un revenu de $${income}.`];
        let tax = 0;
        if (income <= 51780) {
            tax = income * 0.14;
            logs.push(`Le revenu jusqu'à $51,780 est imposé à 14% : $${tax.toFixed(2)}`);
        } else {
            let initialTax = 51780 * 0.14;
            tax = initialTax;
            logs.push(`Les premiers $51,780 sont imposés à 14% : $${initialTax.toFixed(2)}`);
            if (income <= 103545) {
                tax += (income - 51780) * 0.19;
                logs.push(`Le revenu de $51,780 à $103,545 est imposé à 19% : $${((income - 51780) * 0.19).toFixed(2)}`);
            } else {
                let middleTax = (103545 - 51780) * 0.19;
                tax += middleTax;
                logs.push(`Les $51,765 suivants sont imposés à 19% : $${middleTax.toFixed(2)}`);
                if (income <= 126000) {
                    tax += (income - 103545) * 0.24;
                    logs.push(`Le revenu de $103,545 à $126,000 est imposé à 24% : $${((income - 103545) * 0.24).toFixed(2)}`);
                } else {
                    let higherTax = (126000 - 103545) * 0.24;
                    tax += higherTax;
                    tax += (income - 126000) * 0.2575;
                    logs.push(`Les $22,455 suivants sont imposés à 24% : $${higherTax.toFixed(2)}`);
                    logs.push(`Le revenu supérieur à $126,000 est imposé à 25.75% : $${((income - 126000) * 0.2575).toFixed(2)}`);
                }
            }
        }
        return [tax, logs];
    }

    function calculateTotalTax() {

        // Income
        const employmentIncome = parseFloat(document.getElementById('employmentIncome').value) || 0;
        const capitalGains = parseFloat(document.getElementById('capitalGains').value) || 0;
        const determinedDividend = parseFloat(document.getElementById('determinedDividend').value) || 0;
        const undeterminedDividend = parseFloat(document.getElementById('undeterminedDividend').value) || 0;
        const propertyIncome = parseFloat(document.getElementById('propertyIncome').value) || 0;
        const businessIncome = parseFloat(document.getElementById('businessIncome').value) || 0;

        const totalIncome = employmentIncome + capitalGains + (determinedDividend * 1.38) + (undeterminedDividend * 1.15) + propertyIncome + businessIncome;
        
        if (isNaN(totalIncome) || totalIncome === 0) {
            document.getElementById('result').textContent = 'Veuillez entrer un chiffre valide dans au moins une catégorie.';
            return;
        }

        // Deduction - TO DO

        // Tax Calculations and logs
        const [federalTax, federalLogs] = calculateFederalTax(totalIncome);
        const [quebecTax, quebecLogs] = calculateQuebecTax(totalIncome);
        const totalTax = federalTax + quebecTax;

        // Tax credits - TO DO 

        // Logs

        const totalLogs = [...federalLogs, ...quebecLogs, `Calcul total des impôts : Impôt fédéral $${federalTax.toFixed(2)} + Impôt du Québec $${quebecTax.toFixed(2)} = $${totalTax.toFixed(2)}`];

        logDetailedResults(totalLogs);

        document.getElementById('result').innerHTML = `<strong>Détail des Impôts:</strong><br>` +
                                                      `Impôt fédéral estimé: $${federalTax.toFixed(2)}<br>` +
                                                      `Impôt du Québec estimé: $${quebecTax.toFixed(2)}<br>` +
                                                      `Impôt total estimé: $${totalTax.toFixed(2)}`;

        
    }

    function resetFields() {
        document.getElementById('employmentIncome').value = '';
        document.getElementById('capitalGains').value = '';
        document.getElementById('determinedDividend').value = '';
        document.getElementById('undeterminedDividend').value = '';
        document.getElementById('propertyIncome').value = '';
        document.getElementById('businessIncome').value = '';
        document.getElementById('result').innerHTML = '';
    }

    function showLogs() {
        document.getElementById('toastBody').textContent = detailedLogs;
        var toastLiveExample = document.getElementById('liveToast');
        var toast = new bootstrap.Toast(toastLiveExample);
        toast.show();
    }
    
    // Calculate tax based on the income and tax rates
    function calculateTax(income) {
        let tax = 0;
        if (income <= 55867) {
            tax = income * 0.15;
        } else if (income <= 111733) {
            tax = 55867 * 0.15 + (income - 55867) * 0.205;
        } else if (income <= 173205) {
            tax = 55867 * 0.15 + (111733 - 55867) * 0.205 + (income - 111733) * 0.26;
        } else if (income <= 246752) {
            tax = 55867 * 0.15 + (111733 - 55867) * 0.205 + (173205 - 111733) * 0.26 + (income - 173205) * 0.29;
        } else {
            tax = 55867 * 0.15 + (111733 - 55867) * 0.205 + (173205 - 111733) * 0.26 + (246752 - 173205) * 0.29 + (income - 246752) * 0.33;
        }
        return tax;
    }

    // Function to calculate REER impact
    function calculateReerImpact() {
        const investment = parseFloat(document.getElementById('reerInput').value);
        const totalIncome = parseFloat(document.getElementById('totalIncome').value) || 0;
        if (isNaN(investment) || isNaN(totalIncome)) {
            alert("Veuillez entrer un montant valide.");
            return;
        }
        const originalTax = calculateTax(totalIncome);
        const newTax = calculateTax(totalIncome - investment);
        const taxImpact = originalTax - newTax;
        alert(`En allouant ${investment.toLocaleString('fr-CA')} CAD à votre REER, vous allez réduire votre obligation fiscale d'environ ${taxImpact.toLocaleString('fr-CA')} CAD.`);
    }

    // Function to calculate CELIAPP impact
    function calculateCeliappImpact() {
        const investment = parseFloat(document.getElementById('celiappInput').value);
        const totalIncome = parseFloat(document.getElementById('totalIncome').value) || 0;
        if (isNaN(investment) || isNaN(totalIncome)) {
            alert("Veuillez entrer un montant valide.");
            return;
        }
        const originalTax = calculateTax(totalIncome);
        const newTax = calculateTax(totalIncome - investment); // Assuming CELIAPP also reduces taxable income
        const taxImpact = originalTax - newTax;
        alert(`En allouant ${investment.toLocaleString('fr-CA')} CAD à votre CELIAPP, vous allez réduire votre obligation fiscale d'environ ${taxImpact.toLocaleString('fr-CA')} CAD.`);
    }

    // Function to calculate DGC impact
    function calculateDgcImpact() {
        const donation = parseFloat(document.getElementById('dgcInput').value);
        const totalIncome = parseFloat(document.getElementById('totalIncome').value) || 0;
        if (isNaN(donation) || isNaN(totalIncome)) {
            alert("Veuillez entrer un montant valide.");
            return;
        }
        const originalTax = calculateTax(totalIncome);
        const newTax = calculateTax(totalIncome - donation); // Assuming donation also reduces taxable income
        const taxImpact = originalTax - newTax;
        alert(`En faisant un don de ${donation.toLocaleString('fr-CA')} CAD à DGC, vous allez réduire votre obligation fiscale d'environ ${taxImpact.toLocaleString('fr-CA')} CAD.`);
    }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
