<!DOCTYPE html>
<html>
<head>
    <title>Draw on Photo App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
        }
        #toolbar {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-right: 1px solid #ccc;
        }
        #toolbar button.active {
            background-color: #add8e6;
        }
        #toolbar button:hover {
            background-color: #f0f0f0;
        }
        #toolbar button, #toolbar input {
            margin-bottom: 5px;
        }
        #imageCanvas {
            margin-left: 20px;
            border: 1px solid black;
            cursor: crosshair;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <input type="file" id="imageLoader" class="form-control mb-2">
        <button id="pencil" class="btn btn-light">Pencil</button>
        <button id="line" class="btn btn-light">Line</button>
        <button id="shape" class="btn btn-light">Rectangle</button>
        <button id="circle" class="btn btn-light">Circle</button>
        <button id="triangle" class="btn btn-light">Triangle</button>
        <button id="eraser" class="btn btn-light">Eraser</button>
        <input type="color" id="colorPicker" class="form-control mb-2">
        <button id="undo" class="btn btn-light">Undo</button>
        <button id="save" class="btn btn-light">Save</button>
        <input type="number" id="canvasWidth" class="form-control mb-2" placeholder="Canvas Width" value="800">
        <input type="number" id="canvasHeight" class="form-control mb-2" placeholder="Canvas Height" value="600">
        <button id="resizeCanvas" class="btn btn-info btn-block mb-2">Resize Canvas</button>
    </div>
    <canvas id="imageCanvas" width="800" height="600"></canvas>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <script>
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let startX, startY, endX, endY;
        let history = [];
        let currentTool = 'pencil';
        let currentColor = '#000000';
        let currentLineWidth = 5;
        let shapePreview;

        // Event listeners for toolbar
        document.querySelectorAll('#toolbar button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelector('.active').classList.remove('active');
                this.classList.add('active');
                currentTool = this.id;
            });
        });

        document.getElementById('colorPicker').addEventListener('input', (e) => currentColor = e.target.value);
        document.getElementById('undo').addEventListener('click', undoLastAction);
        document.getElementById('save').addEventListener('click', saveImage);
        document.getElementById('resizeCanvas').addEventListener('click', resizeCanvas);

        // Function definitions
        function startPosition(e) {
            isDrawing = true;
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            if (currentTool !== 'line') {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
            }
            shapePreview = ctx.getImageData(0, 0, canvas.width, canvas.height);
        }

        function finishedPosition(e) {
            isDrawing = false;
            endX = e.clientX - canvas.offsetLeft;
            endY = e.clientY - canvas.offsetTop;
            drawShape();
        }

        function draw(e) {
            if (!isDrawing) return;
            switch (currentTool) {
                case 'pencil':
                case 'eraser':
                    drawFree(e.clientX, e.clientY);
                    break;
                case 'line':
                    if (shapePreview) {
                        ctx.putImageData(shapePreview, 0, 0);
                        drawLine(e.clientX, e.clientY, true);
                    }
                    break;
            }
        }

        function drawShape() {
            switch (currentTool) {
                case 'shape':
                    ctx.rect(startX, startY, endX - startX, endY - startY);
                    ctx.stroke();
                    break;
                case 'circle':
                    let radius = Math.sqrt(Math.pow((startX - endX), 2) + Math.pow((startY - endY), 2)) / 2;
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                case 'triangle':
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, startY);
                    ctx.lineTo((startX + endX) / 2, endY);
                    ctx.closePath();
                    ctx.stroke();
                    break;
                case 'line':
                    drawLine(endX, endY, false);
                    break;
            }
            ctx.beginPath();
            saveCanvasState();
        }

        function drawFree(clientX, clientY) {
            ctx.lineTo(clientX - canvas.offsetLeft, clientY - canvas.offsetTop);
            ctx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
            ctx.lineWidth = currentLineWidth;
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(clientX - canvas.offsetLeft, clientY - canvas.offsetTop);
        }

        function drawLine(clientX, clientY, preview) {
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(clientX - canvas.offsetLeft, clientY - canvas.offsetTop);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentLineWidth;
            ctx.stroke();
            if (!preview) {
                ctx.closePath();
            }
        }

        function saveCanvasState() {
            history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            if (history.length > 10) history.shift();
        }

        function undoLastAction() {
            if (history.length > 1) {
                history.pop();
                ctx.putImageData(history[history.length - 1], 0, 0);
            }
        }

        function resizeCanvas() {
            const width = document.getElementById('canvasWidth').value;
            const height = document.getElementById('canvasHeight').value;
            canvas.width = width;
            canvas.height = height;
            saveCanvasState();
        }

        function saveImage() {
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'my-drawing.png';
            link.href = image;
            link.click();
        }

        function loadImageIntoCanvas(url) {
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0, img.width, img.height);
                saveCanvasState();
            }
            img.src = url;
        }

        document.getElementById('imageLoader').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    loadImageIntoCanvas(event.target.result);
                }
                reader.readAsDataURL(file);
            }     
        });

        // Mouse events
        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', finishedPosition);

        // Set initial active tool
        document.getElementById('pencil').classList.add('active');
    </script>
</body>
</html>